---
import Layout from "@/layouts/Layout.astro";
import { CreateWorkoutPlanWizard } from "@/components/workout-plans/CreateWorkoutPlanWizard";
import type { ExerciseListItemDTO, CategoryDTO } from "@/types";

export const prerender = false;

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/auth/login");
}

// Pobierz ćwiczenia z kategoriami
const { data: exercises, error: exercisesError } = await Astro.locals.supabase
  .from("exercises")
  .select(
    `
    id,
    name,
    description,
    image_path,
    image_alt,
    difficulty,
    category:categories!inner(id, name, slug)
  `
  )
  .order("name");

// Pobierz kategorie dla filtrów
const { data: categories, error: categoriesError } = await Astro.locals.supabase
  .from("categories")
  .select("*")
  .order("order_index");

if (exercisesError || categoriesError) {
  console.error("Error fetching data:", exercisesError || categoriesError);
  return Astro.redirect("/error?message=Nie%20udało%20się%20załadować%20danych");
}

// Transformuj dane do właściwego typu
const exercisesData: ExerciseListItemDTO[] =
  exercises?.map((ex) => ({
    id: ex.id,
    name: ex.name,
    description: ex.description,
    image_path: ex.image_path,
    image_alt: ex.image_alt,
    difficulty: ex.difficulty,
    created_at: ex.created_at,
    category: {
      id: ex.category.id,
      name: ex.category.name,
      slug: ex.category.slug,
    },
  })) || [];

const categoriesData: CategoryDTO[] = categories || [];
---

<Layout title="Tworzenie planu treningowego - Gym Track">
  <div class="container mx-auto px-4 py-8 sm:px-6 lg:px-8">
    <!-- Back Button -->
    <a
      href="/workout-plans"
      class="mb-6 inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground"
    >
      <span class="material-symbols-outlined text-base">arrow_back</span>
      Powrót do planów
    </a>

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">Nowy plan treningowy</h1>
      <p class="mt-2 text-muted-foreground">Stwórz spersonalizowany plan treningowy w 3 krokach</p>
    </div>

    <!-- Wizard -->
    <div class="mx-auto max-w-5xl">
      <CreateWorkoutPlanWizard exercises={exercisesData} categories={categoriesData} client:load />
    </div>
  </div>
</Layout>
